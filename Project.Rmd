---
title: "Understanding Patterns of Road Safety"
author: "Yicong Wu, Yujun Wang, Sibo Wang"

output: 
  html_document:
    toc: true
    toc_depth: 3
    theme: cerulean
    highlight: tango
---

### Preamble: Loading packages and data

```{r}
library(ggplot2)
library(ISLR)
library(MASS)
library(klaR)
library(knitr)
library(glmnet)
library(plyr)
library(gam)
library(cluster) 
library(fpc)
library(ggmap)

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

options(scipen = 4)
```

For this problem we'll be working with two years of bikeshare data from the Capital Bikeshare system in Washington DC.  The dataset contains daily bikeshare counts, along with daily measurements on environmental and seasonal information that may affect the bikesharing.  

### Data pre-processing 

Let's start by loading the data.

```{r}
AccidentData <- read.csv("http://www.andrew.cmu.edu/user/achoulde/95791/projects/Project%20D/DfTRoadSafety_Accidents_2012.csv", header = TRUE)

# Transform temp and atemp to degrees C instead of [0,1] scale
# Transform humidity to %
# Transform wind speed (multiply by 67, the normalizing value)

#bikes <- transform(bikes,
#                   temp = 47 * temp - 8,
 #                  atemp = 66 * atemp - 16,
  #                 hum = 100 * hum,
   #                windspeed = 67 * windspeed)

# The mapvalues() command from the plyr library allows us to easily
# rename values in our variables.  Below we use this command to change season
# from numeric codings to season names.

#bikes <- transform(bikes, 
 #                  season = mapvalues(season, c(1,2,3,4), 
  #                                    c("Winter", "Spring", "Summer", "Fall")))
#plot(x=AccidentData$Longitude,y=AccidentData$Latitude)

panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
     usr <- par("usr"); on.exit(par(usr))
     par(usr = c(0, 1, 0, 1))
     r <- abs(cor(x, y))
     txt <- format(c(r, 0.123456789), digits = digits)[1]
     txt <- paste0(prefix, txt)
     if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
     text(0.5, 0.5, txt, cex = pmax(1, cex.cor * r))
}
#pairs(~Accident_Severity+Number_of_Vehicles+Number_of_Casualties+X1st_Road_Class+Junction_Detail,data=AccidentData,lower.panel = panel.cor)
```

Now I am going to split these data 
```{r}
set.seed(531)

# Randomly select 20% of the data to be held out for model validation
AccidentData.1.test.idx <- sample(which(AccidentData$Accident_Severity == 1),length(which(AccidentData$Accident_Severity == 1))*0.2,replace =TRUE)
AccidentData.2.test.idx <- sample(which(AccidentData$Accident_Severity == 2),length(which(AccidentData$Accident_Severity == 2))*0.2,replace =TRUE)
AccidentData.3.test.idx <- sample(which(AccidentData$Accident_Severity == 3),length(which(AccidentData$Accident_Severity == 3))*0.2,replace =TRUE)
AccidentData.test.ind <- c(AccidentData.1.test.idx,AccidentData.2.test.idx,AccidentData.3.test.idx)
AccidentData.train.ind <- setdiff(1:nrow(AccidentData), AccidentData.test.ind)

# Just pull the covariates available to marketers (cols 1:8) and the outcome (col 17)
AccidentData.train <- AccidentData[AccidentData.train.ind, c(10,11,12,17,18,23,25,26,27,30,7)]
AccidentData.test <- AccidentData[AccidentData.test.ind, c(10,11,12,17,18,23,25,26,27,30,7)]
AccidentData.location <- AccidentData[,c(4,5,7)]
```

Run Clustering method on Longitude and Latitude

```{r,cache = TRUE}
#plot the longitude and latitude in 1-D
#plot(AccidentData.location$Longitude)
#plot(AccidentData.location$Latitude)


mapgilbert <- get_map(location = c(lon = mean(AccidentData.location$Longitude), lat = mean(AccidentData.location$Latitude)), zoom = 5, scale = 2)

ggmap(mapgilbert) + geom_point(data = AccidentData.location, aes(x = Longitude, y = Latitude, fill = "red", alpha = 0.8), size = 5, shape = 21) +guides(fill=FALSE, alpha=FALSE, size=FALSE)
```




```{r}
#rescaling and plot
AccidentData.location$Longitude <- (AccidentData.location$Longitude +8)*100
AccidentData.location$Latitude <- (AccidentData.location$Latitude  - 50)*10
AccidentData.location.1 <- AccidentData.location[which(AccidentData.location$Accident_Severity==1),c(1,2)]
AccidentData.location.2 <- AccidentData.location[which(AccidentData.location$Accident_Severity==2),]
AccidentData.location.3 <- AccidentData.location[which(AccidentData.location$Accident_Severity==3),]

#plot(AccidentData.location$Longitude[which(AccidentData.location$Accident_Severity==2)],AccidentData.location$Latitude[which(AccidentData.location$Accident_Severity==2)])
#plot(AccidentData.location$Longitude[which(AccidentData.location$Accident_Severity==3)],AccidentData.location$Latitude[which(AccidentData.location$Accident_Severity==3)])
#plot(AccidentData.location$Longitude[which(AccidentData.location$Accident_Severity==1)],AccidentData.location$Latitude[which(AccidentData.location$Accident_Severity==1)],xlab = "Longitude", ylab = "Latitude",col = AccidentData.location$Accident_Severity[which(AccidentData.location$Accident_Severity==1)])
```
 
 
```{r}
Acc.location.clu.1 <- kmeans(AccidentData.location.1,10)
Acc.location.clu.2 <- kmeans(AccidentData.location.2,10)
Acc.location.clu.3 <- kmeans(AccidentData.location.3,10)
Acc.location.clu <- kmeans(AccidentData.location,30)
#plot(AccidentData.location$Longitude[which(AccidentData.location$Accident_Severity==1)],AccidentData.location$Latitude[which(AccidentData.location$Accident_Severity==1)],xlab = "Longitude", ylab = "Latitude")

#plotcluster(AccidentData.location, Acc.location.clu.1$cluster)

```